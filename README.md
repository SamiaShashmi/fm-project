# Single-Cell RNA-seq Foundation Model Project

This project implements and compares various deep learning foundation models for single-cell RNA sequencing (scRNA-seq) analysis, focusing on trajectory inference and cell state generation across three biological processes: epithelial-mesenchymal transition (EMT), hematopoiesis, and thymocyte development.

## Project Structure

```
fm-project/
‚îú‚îÄ‚îÄ data/                   # Datasets and generated samples
‚îú‚îÄ‚îÄ experiments/            # Jupyter notebooks for model experiments
‚îú‚îÄ‚îÄ models/                 # Saved model checkpoints
‚îú‚îÄ‚îÄ src/                    # Source code implementations
‚îú‚îÄ‚îÄ utils/                  # Utility functions
‚îú‚îÄ‚îÄ .conda/                 # Local conda environment
‚îî‚îÄ‚îÄ output.png              # Visualization output
```

## Directory Contents

### üìä `data/` - Datasets and Generated Samples
Contains preprocessed single-cell expression datasets and synthetic samples generated by different models:

**Original Datasets:**
- `emt.h5ad` - Epithelial-Mesenchymal Transition dataset
- `hematopoiesis.h5ad` - Hematopoiesis dataset  
- `thymocyte.h5ad` - Thymocyte development dataset

**Preprocessed Datasets:**
- `emt_diff.h5ad` - EMT dataset preprocessed for scDiffusion
- `hem_diff.h5ad` - Hematopoiesis dataset preprocessed for scDiffusion
- `thy_diff.h5ad` - Thymocyte dataset preprocessed for scDiffusion

**Synthetic Data:**
- `syn_[dataset]_[model].h5ad` - Synthetic samples generated by each model
  - Models: `scnode`, `scdiff`, `scgpt`, `scvi`
  - Datasets: `emt`, `hem`, `thy`

**Additional Files:**
- `emt_trajectory_expression.csv` - EMT trajectory expression data
- `generated/` - Interpolation results (11 `.npz` files)

### üß™ `experiments/` - Model Training and Evaluation Notebooks
Jupyter notebooks for preprocessing data and running different models:

**Data Preprocessing:**
- `emt_preprocess.ipynb` - EMT dataset preprocessing
- `hematopoiesis_preprocess.ipynb` - Hematopoiesis dataset preprocessing  
- `thymocyte_preprocess.ipynb` - Thymocyte dataset preprocessing

**Model Experiments:**
Each model has dedicated notebooks for each dataset:
- **scNODE**: `scnode_[dataset].ipynb` - Neural ODE-based generative model
- **scDiffusion**: `scdiff_[dataset].ipynb` - Diffusion model for cell generation
- **scGPT**: `scgpt_[dataset].ipynb` - GPT-based foundation model
- **scVI**: `scvi_[dataset].ipynb` - Variational inference model

### ü§ñ `models/` - Saved Model Checkpoints
Contains trained model weights:

- `scnode/` - scNODE model checkpoints
  - `latent_ode_model_emt.pth` - EMT-trained model
  - `latent_ode_model_hem.pth` - Hematopoiesis-trained model
  - `latent_ode_model_thy.pth` - Thymocyte-trained model
- `scdiff/` - scDiffusion model checkpoints (empty - models may be loaded from external sources)
- `scgpt/` - scGPT model checkpoints (empty - models may be loaded from external sources)

### üíª `src/` - Source Code Implementations
Contains the implementation of two main models:

#### `src/scNODE/` - Neural ODE Model Implementation
Generative model for temporal single-cell transcriptomic data prediction:
- `model/` - Core scNODE model implementation
- `baseline/` - Baseline model implementations
- `benchmark/` - Benchmarking scripts
- `optim/` - Loss functions and optimization utilities
- `data/` - Data preprocessing scripts
- `downstream_analysis/` - Perturbation analysis and trajectory recovery
- `model_validation/` - Ablation studies and hyperparameter analysis
- `plotting/` - Visualization utilities
- `paper_figs/` - Scripts for paper figures
- `README.md` - Detailed scNODE documentation
- `environment.yml` - Conda environment specification

#### `src/scDiffusion/` - Diffusion Model Implementation
Conditional generation of high-quality single-cell data:
- `guided_diffusion/` - Core diffusion model components
- `VAE/` - Variational autoencoder implementation
- `cell_train.py` - Main training script for diffusion backbone
- `cell_sample.py` - Sampling/generation script
- `classifier_train.py` - Classifier training for conditional generation
- `classifier_sample.py` - Conditional sampling with classifier guidance
- `celltypist_train.py` - Cell type classification
- `exp_script/` - Experiment scripts
- `train.sh` - Training pipeline script
- `README.md` - Detailed scDiffusion documentation

### üîß `utils/` - Utility Functions
Helper functions for data processing and evaluation:
- `__init__.py` - Package initialization
- `adata.py` - AnnData object utilities
- `evaluation.py` - Evaluation metrics including marker gene monotonicity
- `latent.py` - Latent space analysis utilities
- `plot.py` - Plotting utilities

### üìù Additional Files
- `.gitignore` - Git ignore rules for data files and caches
- `.git/` - Git repository metadata
- `.conda/` - Local conda environment (currently empty)
- `output.png` - Generated visualization output

## Models Overview

### 1. **scNODE** (Neural ODE-based)
- Combines Variational Autoencoder (VAE) with Neural Ordinary Differential Equations
- Models cell developmental landscapes on non-linear manifolds
- Generates realistic in silico single-cell gene expressions at any timepoint

### 2. **scDiffusion** (Diffusion Model)
- Combines latent diffusion models with pre-trained models
- Conditional generation of high-quality single-cell data
- Uses classifier guidance for controlled generation

### 3. **scGPT** (Transformer-based)
- GPT-based foundation model for single-cell analysis
- Leverages transformer architecture for cell state modeling

### 4. **scVI** (Variational Inference)
- Variational inference-based model for single-cell data
- Probabilistic modeling of gene expression

## Datasets

The project analyzes three key biological processes:

1. **EMT (Epithelial-Mesenchymal Transition)**: ~28MB dataset capturing cell state transitions
2. **Hematopoiesis**: ~472MB dataset of blood cell development
3. **Thymocyte Development**: ~649MB dataset of T-cell maturation

## Key Features

- **Multi-model Comparison**: Systematic evaluation of four different deep learning approaches
- **Trajectory Inference**: Models cellular developmental trajectories
- **Synthetic Data Generation**: Creates realistic synthetic single-cell data
- **Comprehensive Evaluation**: Includes marker gene monotonicity and trajectory smoothness metrics
- **Scalable Implementation**: Handles large-scale single-cell datasets

## Dependencies

The project uses various deep learning and single-cell analysis libraries. Key dependencies include:
- PyTorch (for deep learning models)
- Scanpy/AnnData (for single-cell data handling)
- NumPy/Pandas (for data processing)
- Scikit-learn (for machine learning utilities)

For specific version requirements, refer to:
- `src/scNODE/environment.yml` for scNODE dependencies
- `src/scNODE/installation` for additional requirements
- `src/scDiffusion/README.md` for scDiffusion environment

## Usage

1. **Data Preprocessing**: Use notebooks in `experiments/` for data preparation
2. **Model Training**: Run model-specific notebooks for training
3. **Generation**: Use trained models to generate synthetic cells
4. **Evaluation**: Apply utilities in `utils/evaluation.py` for assessment

## Notes

- The `.conda/` directory can be used for a local conda environment with: `conda create -p .conda python=3.8`
- Large data files (`.h5ad`, `.csv`, `.json`, etc.) are excluded from version control via `.gitignore`
- Model checkpoints are saved in the `models/` directory for reproducibility

## Citation

This project integrates multiple published methods. Please cite the relevant papers when using specific models:
- scNODE: [bioRxiv preprint](https://www.biorxiv.org/content/10.1101/2023.11.22.568346v2)
- scDiffusion: [Bioinformatics paper](https://doi.org/10.1093/bioinformatics/btae518)
